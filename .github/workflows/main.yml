name: Build and Deploy to EC2 via Docker

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v2

      # 2ï¸âƒ£ JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ï¸âƒ£ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Ensure gradlew is executable
        run: chmod +x gradlew

      # 4ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          ./gradlew clean build
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/mydb
          SPRING_DATASOURCE_USERNAME: kss
          SPRING_DATASOURCE_PASSWORD: root

      # 5ï¸âƒ£ ë¹Œë“œëœ JAR íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸° (plain ì œì™¸)
      - name: Get JAR filename
        id: get_jar
        run: |
          JAR_NAME=$(ls build/libs/gaia-*.jar | grep -v plain | head -n 1)
          echo "JAR_NAME=$JAR_NAME" >> $GITHUB_ENV

      # 6ï¸âƒ£ Docker Hub ë¡œê·¸ì¸ (Personal Access Token ì‚¬ìš©)
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê¹…
      - name: Build and tag Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/gaia-app:latest .

      # 8ï¸âƒ£ Docker Hubì— í‘¸ì‹œ
      - name: Push Docker image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/gaia-app:latest

      # 9ï¸âƒ£ EC2ì— Docker Compose íŒŒì¼ ì „ì†¡
      - name: Upload Docker Compose file to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/home/ubuntu/docker-compose.yml"

      # ğŸ”Ÿ EC2ì—ì„œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: SSH to EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            docker stop gaia-app || true
            docker rm gaia-app || true
            docker stop gaia-db || true
            docker rm gaia-db || true

            # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            docker pull ${{ secrets.DOCKER_USERNAME }}/gaia-app:latest

            # Docker Compose ì‹¤í–‰
            docker-compose -f /home/ubuntu/docker-compose.yml up -d
